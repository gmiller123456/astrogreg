<html>
<head>
<title>Darkness Graph</title>
<link rel="stylesheet" href="../default.css">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
</style>
</head>    
<body>
<h1>Darkness Graph</h1>
<h3>Sunrise, Sunset, Moonrise, Moonset, Twlight, Moon Illumination</h3>
<p>Computations valid for 1950-2050.</p>
<p style="background-color: red; color:white; font-weight: bold;">Alpha Application:  Still under testing.</p>
<form>
    <table>
        <tr><td align=right>Start Date:</td><td><input type=date id="startDate"></td><td><input type=button value="Today" onclick='setDateToNow();'></td></tr>
        <tr><td align=right>Lattitude:</td><td><input type=text id="lat"></td><td><input type=button value="Get Location" onclick='getUserPosition();'><td></tr>
        <tr><td align=right>Longitude:</td><td><input type=text id="lon"></td></tr>
        <tr><td align=right>Days:</td><td><input type=text id="days" value="365"></td></tr>
            <tr><td></td><td><input type=button value="Compute" onclick="generateGraph();"></td></tr>
    </table>
</form>
    
<!--div id="follow" style="position:absolute; background:red;">Follow</div-->
<div id="output"></div>
<script src="Graph.js"></script>
<script>
//Darkness graph.
//Greg Miller (gmiller@gregmiller.net)
//http://www.celestialprogramming.com/
//Released as public domain

const torad=Math.PI/180.0;
const toRad=Math.PI/180.0;
const toDeg=180.0/Math.PI;

let riseSetData;

function generateGraph(){
    document.getElementById("output").innerHTML="";
    const d=new Date(document.getElementById("startDate").value);
    const jd=Math.floor(JulianDateFromUnixTime(d.getTime()))-.5;

    const lat=(document.getElementById("lat").value-0)*torad;
    const lon=(document.getElementById("lon").value-0)*torad;
    const days=(document.getElementById("days").value-0);

    riseSetData=generateRiseSetTimes(jd,days,lat,lon);

    new Graph(riseSetData);
}

function generateRiseSetTimes(startJD,count,lat,lon){

    const data=new Array();
    for(let i=0;i<count;i++){
        let jd=startJD+i;
        const t={};
        t.jd=jd;
        t.sun=sunPosition(jd);
        t.moon=getGeocentricMoonPos(jd);

        t.sunRST=getRiseSet(jd,lat,lon,t.sun[0],t.sun[1],-0.8333);
        t.moonRST=getRiseSet(jd,lat,lon,t.moon[0],t.moon[1],0.125);
        t.civilTwilightRST=getRiseSet(jd,lat,lon,t.sun[0],t.sun[1],-6.0);
        t.astroTwilightRST=getRiseSet(jd,lat,lon,t.sun[0],t.sun[1],-18.0);

        t.moonIllunination=getIlluminatedFractionOfMoon(jd);

        data[i]=t;
    }
    return data;
}

function JulianDateFromUnixTime(t){
	//Not valid for dates before Oct 15, 1582
	return (t / 86400000) + 2440587.5;
}

function UnixTimeFromJulianDate(jd){
	//Not valid for dates before Oct 15, 1582
	return (jd-2440587.5)*86400000;
}

//Low precision sun position from Astronomical Almanac page C5 (2017 ed).
//Accuracy 1deg from 1950-2050
function sunPosition(jd)	{
	const torad=Math.PI/180.0;
	n=jd-2451545.0;
	L=(280.460+0.9856474*n)%360;
	g=((375.528+.9856003*n)%360)*torad;
	if(L<0){L+=360;}
	if(g<0){g+=Math.PI*2.0;}

	lamba=(L+1.915*Math.sin(g)+0.020*Math.sin(2*g))*torad;
	beta=0.0;
	eps=(23.439-0.0000004*n)*torad;
	ra=Math.atan2(Math.cos(eps)*Math.sin(lamba),Math.cos(lamba));
	dec=Math.asin(Math.sin(eps)*Math.sin(lamba));
	if(ra<0){ra+=Math.PI*2;}
	return [ra,dec];
}

function sind(r){
	return Math.sin(r*torad);
}

function cosd(r){
	return Math.cos(r*torad);
}

//Low precision geocentric moon position (RA,DEC) from Astronomical Almanac page D22 (2017 ed)
function getGeocentricMoonPos(jd){
	let T = (jd-2451545)/36525;
	let L = 218.32 + 481267.881*T + 6.29*sind(135.0 + 477198.87*T) - 1.27*sind(259.3 - 413335.36*T) + 0.66*sind(235.7 + 890534.22*T) + 0.21*sind(269.9 + 954397.74*T) - 0.19*sind(357.5 + 35999.05*T) - 0.11*sind(186.5 + 966404.03*T);
	let B = 5.13*sind( 93.3 + 483202.02*T) + 0.28*sind(228.2 + 960400.89*T) - 0.28*sind(318.3 + 6003.15*T) - 0.17*sind(217.6 - 407332.21*T);
	let P = 0.9508 + 0.0518*cosd(135.0 + 477198.87*T) + 0.0095*cosd(259.3 - 413335.36*T) + 0.0078*cosd(235.7 + 890534.22*T) + 0.0028*cosd(269.9 + 954397.74*T);

	let SD=0.2724*P;
	let r=1/sind(P);

	let l = cosd(B) * cosd(L);
	let m = 0.9175*cosd(B)*sind(L) - 0.3978*sind(B);
	let n = 0.3978*cosd(B)*sind(L) + 0.9175*sind(B);

	let ra=Math.atan2(m,l);
	if(ra<0){ra+=2*Math.PI;}
	let dec=Math.asin(n);
	return [ra,dec];
}

function constrain(d){
    let t=d%360;
    if(t<0){t+=360;}
    return t;
}

function getIlluminatedFractionOfMoon(jd){
    const toRad=Math.PI/180.0;
    const T=(jd-2451545)/36525.0;

    const D = constrain(297.8501921 + 445267.1114034*T - 0.0018819*T*T + 1.0/545868.0*T*T*T - 1.0/113065000.0*T*T*T*T)*toRad; //47.2
    const M = constrain(357.5291092 + 35999.0502909*T - 0.0001536*T*T + 1.0/24490000.0*T*T*T)*toRad; //47.3
    const Mp = constrain(134.9633964 + 477198.8675055*T + 0.0087414*T*T + 1.0/69699.0*T*T*T - 1.0/14712000.0*T*T*T*T)*toRad; //47.4

    //48.4
    const i=constrain(180 - D*180/Math.PI - 6.289 * Math.sin(Mp) + 2.1 * Math.sin(M) -1.274 * Math.sin(2*D - Mp) -0.658 * Math.sin(2*D) -0.214 * Math.sin(2*Mp) -0.11 * Math.sin(D))*toRad;

    const k=(1+Math.cos(i))/2;
    return k;
}

//By Greg Miller gmiller@gregmiller.net www.astrogreg.com
//Released as public domain

//Corrects values to make them between 0 and 1
function constrain2(v){
	if(v<0){return v+1;}
	if(v>1){return v-1;}
	return v;
}

//All angles must be in radians
//Outputs are times in hours GMT (not accounting for daylight saving time)
//cosH, if < -1, always up, if > 1 never up
//From Meeus Page 101
function getRiseSet(jd,lat,lon,ra,dec,h0){
	//const h0=-0.8333 //For Sun
	//const h0=-0.5667 //For stars and planets
	//const h0=0.125   //For Moon

    const cosH=(Math.sin(h0*Math.PI/180.0)-Math.sin(lat)*Math.sin(dec)) / (Math.cos(lat)*Math.cos(dec));
	const H0=Math.acos(cosH)*180.0/Math.PI;

	const gmst=GMST(Math.floor(jd)+.5);

	const transit=(ra*toDeg+lon*toDeg-gmst)/360.0;
	const rise=transit-(H0/360.0);
	const set=transit+(H0/360.0);

	return [constrain2(transit)*24.0,constrain2(rise)*24.0,constrain2(set)*24.0,cosH];
}

//Greenwhich mean sidreal time from Meeus page 87
//Input is julian date, does not have to be 0h
//Output is angle in degrees
function GMST(jd){
	const T=(jd-2451545.0)/36525.0;
	let st=280.46061837+360.98564736629*(jd-2451545.0)+0.000387933*T*T - T*T*T/38710000.0;
	st=st%360;
	if(st<0){st+=360;}

	return st;
	//return st*Math.PI/180.0;
}

function init(){
	setDateToNow();

	document.getElementById("lat").value=38.2527;
	document.getElementById("lon").value=85.7585;

    generateGraph();
}

function getUserPosition(){
	navigator.geolocation.getCurrentPosition(showPosition);
}

function showPosition(p){

	document.getElementById("lat").value=p.coords.latitude;
	document.getElementById("lon").value=-p.coords.longitude;
}

function setDateToNow(){
    document.getElementById("startDate").valueAsDate=new Date();
    generateGraph();
}


init();


</script>
</body>
</html>
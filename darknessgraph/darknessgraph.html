<html>
<head>
<title>Darkness Graph</title>
<link rel="stylesheet" href="../default.css">
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
</style>
</head>    
<body>
<h1>Darkness Graph</h1>
<h3>Sunrise, Sunset, Moonrise, Moonset, Twlight, Moon Illumination</h3>
<p>Computations valid for 1950-2050.</p>
<p style="background-color: red; color:white; font-weight: bold;">Alpha Application:  Still under testing.</p>
<form>
    <table>
        <tr><td align=right>Start Date:</td><td><input type=date id="startDate"></td><td><input type=button value="Today" onclick='setDateToNow();'></td></tr>
        <tr><td align=right>Lattitude:</td><td><input type=text id="lat"></td><td><input type=button value="Get Location" onclick='getUserPosition();'><td></tr>
        <tr><td align=right>Longitude:</td><td><input type=text id="lon"></td></tr>
        <tr><td align=right>Days:</td><td><input type=text id="days" value="90"></td></tr>
        <tr><td align=right>Time Zone:</td><td><select id="timeZoneSelect"><option>EDT</option></select></td></tr>

        <tr><td></td><td><input type=button value="Compute" onclick="generateGraph();"></td></tr>
    </table>
    <div style="background-color:#ddd">Constellations:<div id="constellationList"></div></div>
</form>
    
<!--div id="follow" style="position:absolute; background:red;">Follow</div-->
<div id="output"></div>
<script src="astro.js"></script>
<script src="Graph.js"></script>
<script>
//Darkness graph.
//Greg Miller (gmiller@gregmiller.net)
//http://www.celestialprogramming.com/
//Released as public domain

let riseSetData;
populatConstellations();

function populatConstellations(){
    const e=document.getElementById("constellationList");
    const s=document.createElement("select");
    s.id="constellationsSelection";
    s.multiple=true;
    s.size=10;
    for(let i=0;i<constellations.length;i++){

        const o=document.createElement("option");
        o.text=constellations[i][1];
        o.value=i;
        s.add(o);
    }
    e.appendChild(s);
}

function generateGraph(){
    document.getElementById("output").innerHTML="";
    const d=new Date(document.getElementById("startDate").value);
    const jd=Math.floor(JulianDateFromUnixTime(d.getTime()))-.5;

    const lat=(document.getElementById("lat").value-0)*torad;
    const lon=(document.getElementById("lon").value-0)*torad;
    const days=(document.getElementById("days").value-0);

    riseSetData=generateRiseSetTimes(jd,days,lat,lon);

    new Graph(riseSetData);
}

function generateRiseSetTimes(startJD,count,lat,lon){

    const data=new Array();
    for(let i=0;i<count;i++){
        let jd=startJD+i;
        const t={};
        t.jd=jd;
        t.sun=sunPosition(jd);

        t.sunRST=getRiseSet(jd,lat,lon,t.sun[0],t.sun[1],-0.8333);
        t.civilTwilightRST=getRiseSet(jd,lat,lon,t.sun[0],t.sun[1],-6.0);
        t.astroTwilightRST=getRiseSet(jd,lat,lon,t.sun[0],t.sun[1],-18.0);

        t.moon=getGeocentricMoonPos(jd);
        t.moonRST=getRiseSet(jd,lat,lon,t.moon[0],t.moon[1],0.125);
        /*
        TODO: recompute moon RST for actual rise and set time position
        const moonR=getGeocentricMoonPos(jd+t.moonRST[1]/24.0);
        t.moonRST[1]=getRiseSet(jd,lat,lon,moonR[0],moonR[1],0.125)[1];
        const moonS=getGeocentricMoonPos(jd+t.moonRST[2]/24.0);
        t.moonRST[2]=getRiseSet(jd,lat,lon,moonS[0],moonS[1],0.125)[2];
        */

        t.other=getRiseSet(jd,lat,lon,constellations[25][2]*15*torad,constellations[25][3]*torad,0);

        t.moonIllunination=getIlluminatedFractionOfMoon(jd);
        t.date=new Date(UnixTimeFromJulianDate(jd));
        t.tz=t.date.getTimezoneOffset()/60.0;

        data[i]=t;
    }
    return data;
}

function init(){
	setDateToNow();

	document.getElementById("lat").value=38.2527;
	document.getElementById("lon").value=-85.7585;

    generateGraph();
}

function getUserPosition(){
	navigator.geolocation.getCurrentPosition(showPosition);
}

function showPosition(p){
	document.getElementById("lat").value=p.coords.latitude;
	document.getElementById("lon").value=p.coords.longitude;
}

function setDateToNow(){
    document.getElementById("startDate").valueAsDate=new Date();
}

init();
</script>
</body>
</html>